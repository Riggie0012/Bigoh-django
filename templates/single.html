{% extends 'base.html' %}
{% block title %}Products{% endblock %}
{% block content %}
<div class="container-fluid">
     <!-- Include Navbar -->
         
          <section class="row g-4 py-4">
               <div class="col-md-5 col-lg-4">
	       <!-- product variable holds the Current Product, This comes from /single_item route in app.py  -->
               <!-- product variable is indexed from 0  - 5  to access specific product details
               product[1] is product name, product[5] represent product image etc..  -->
                      <div class="card p-3 product-image-card">
                        
                        <img src="{{ image_url(product[7]) }}" alt="{{ product[1] }}" class="img-fluid rounded" loading="lazy" decoding="async">
                      </div>
                      <div class="mt-3">
                        <h3 class="fw-bold">{{ product[1] }}</h3>
                        <div class="text-muted small">Category: {{ product[2] }}</div>
                      </div>
               </div>

              <div class="col-md-7 col-lg-8">
                     <div class="card p-4 mb-4">
                     <p class="text-muted">{{ product[6] }}</p>
                     <h4 class="text-danger fw-bold">KES {{ product[4] }}</h4>
                     {% if review_count and review_count > 0 %}
                     <div class="d-flex align-items-center gap-2 mb-2">
                       <span class="text-warning">
                         {% for i in range(1, 6) %}
                           {% if i <= avg_rating_int %}&#9733;{% else %}&#9734;{% endif %}
                         {% endfor %}
                       </span>
                       <span class="text-muted small">{{ avg_rating }}/5</span>
                       <span class="text-muted small">({{ review_count }} reviews)</span>
                     </div>
                     {% else %}
                     <div class="text-muted small mb-2">No reviews yet.</div>
                     {% endif %}
                     <div class="trust-strip mb-3">
                       <span><i class="fa-solid fa-lock"></i> Secure checkout (SSL)</span>
                       <span><i class="fa-solid fa-circle-check"></i> Quality checked</span>
                       <span><i class="fa-solid fa-shield-halved"></i> Dispute support</span>
                     </div>
                     {% if product[5] is not none and product[5]|int <= 5 %}
                     <div class="text-danger small mb-2">Low stock: {{ product[5] }} left</div>
                     {% endif %}

                     <form method="POST" action="/add_to_cart/{{ product[0] }}" class="d-flex align-items-center gap-2">
                   <input type="number" name="qty" value="1" min="1" class="form-control" style="width:120px;">
                 <button class="btn btn-success">Add to Cart</button>
                 </form>
                 </div>

                     
                     <br>

      <section class="row">
	  <div class="col-md-8">
	      {% if request.args.get('err') == 'location' %}
        <div class="alert alert-danger py-2">Please enter delivery location.</div>
          {% endif %}

 <form method="POST" action="{{ url_for('pay_on_delivery') }}" class="card p-3 mt-3">
  <input type="hidden" name="product_id" value="{{ product[0] }}">

  <label class="form-label">Quantity</label>
  <input type="number" name="quantity" value="1" min="1" class="form-control" style="width:140px;" required>

  <label class="form-label mt-2">Delivery Location</label>
  <input type="text" name="location" class="form-control" placeholder="e.g., Nairobi CBD, OTC stage..." required>

  <button type="submit" class="btn btn-success mt-3">
    Pay on Delivery (WhatsApp)
  </button>
</form>

	  </div>
	</section>
        <section class="row mt-4">
          <div class="col-md-12">
            <h4 class="fw-bold">Ratings &amp; Reviews</h4>

            {% if request.args.get('review') == 'ok' %}
              <div class="alert alert-success py-2">Thanks! Your review has been submitted.</div>
            {% elif request.args.get('review') == 'error' %}
              <div class="alert alert-danger py-2">Please provide a rating and comment.</div>
            {% elif request.args.get('review') == 'verified-only' %}
              <div class="alert alert-warning py-2">Photo uploads are available after a completed purchase.</div>
            {% elif request.args.get('review') == 'photo-type' %}
              <div class="alert alert-danger py-2">Photo must be JPG, PNG, or WEBP.</div>
            {% endif %}

            {% if rating_breakdown %}
            <div class="card p-3 mb-3">
              <div class="d-flex flex-wrap align-items-center gap-3">
                <div>
                  <div class="fw-bold">Rating Summary</div>
                  <div class="text-muted small">{{ review_count }} total reviews</div>
                </div>
                <div class="flex-grow-1">
                  {% for star in range(5, 0, -1) %}
                  {% set count = rating_breakdown.get(star, 0) %}
                  {% set pct = (count / review_count * 100) if review_count else 0 %}
                  <div class="d-flex align-items-center gap-2 mb-1">
                    <span class="text-warning">{{ star }}â˜…</span>
                    <div class="progress flex-grow-1" style="height: 8px;">
                      <div class="progress-bar bg-success" style="width: {{ pct }}%"></div>
                    </div>
                    <span class="text-muted small">{{ count }}</span>
                  </div>
                  {% endfor %}
                </div>
              </div>
            </div>
            <div class="text-muted small mb-3">Verified purchase badges are shown when an order is completed.</div>
            {% endif %}

            {% if session.get('key') %}
            <form method="POST" action="/product/{{ product[0] }}/review" class="card p-3 mb-3" enctype="multipart/form-data">
              <div class="row g-2 align-items-end">
                <div class="col-md-3">
                  <label class="form-label">Rating</label>
                  <select name="rating" class="form-select" required>
                    <option value="">Select</option>
                    <option value="5">5 - Excellent</option>
                    <option value="4">4 - Great</option>
                    <option value="3">3 - Good</option>
                    <option value="2">2 - Fair</option>
                    <option value="1">1 - Poor</option>
                  </select>
                </div>
                <div class="col-md-7">
                  <label class="form-label">Comment</label>
                  <input type="text" name="comment" class="form-control" maxlength="500" required>
                </div>
                <div class="col-md-2">
                  <button class="btn btn-primary w-100" type="submit">Submit</button>
                </div>
                <div class="col-md-12">
                  <label class="form-label">Photo (verified purchases only)</label>
                  <input type="file" name="photo" accept="image/png,image/jpeg,image/webp" class="form-control">
                  <div class="form-text">Upload a real photo from your purchase to help others trust the product.</div>
                </div>
              </div>
            </form>
            {% else %}
            <div class="alert alert-info py-2">Please sign in to leave a review.</div>
            <a class="btn btn-outline-primary" href="/signin">Sign In</a>
            {% endif %}
            {% if reviews and reviews|length > 0 %}
              {% for r in reviews %}
              <div class="border rounded p-3 mb-3">
                <div class="d-flex justify-content-between align-items-center">
                  <div class="d-flex align-items-center gap-2">
                    <strong>{{ r.user_name }}</strong>
                    {% if r.verified %}
                      <span class="badge bg-success">Verified purchase</span>
                    {% endif %}
                  </div>
                  <span class="text-muted small">{{ r.created_at }}</span>
                </div>
                <div class="text-warning small mb-1">
                  {% for i in range(1, 6) %}
                    {% if i <= (r.rating or 0) %}&#9733;{% else %}&#9734;{% endif %}
                  {% endfor %}
                </div>
                <div>{{ r.comment }}</div>
                {% if r.photo %}
                  <img src="{{ url_for('static', filename=r.photo) }}" alt="Customer photo" class="review-photo mt-2" loading="lazy" decoding="async">
                {% endif %}
              </div>
              {% endfor %}
            {% else %}
              <div class="text-muted">No reviews yet. Be the first to review this product.</div>
            {% endif %}
          </div>
        </section>

        <section class="row mt-4">
          <div class="col-md-12">
            <h4 class="fw-bold">Customer Photos</h4>
            <div class="card p-3">
              {% set photo_reviews = reviews|selectattr('photo')|list %}
              {% if photo_reviews %}
                <div class="row g-2">
                  {% for r in photo_reviews %}
                  <div class="col-6 col-md-3">
                    <img src="{{ url_for('static', filename=r.photo) }}" alt="Customer photo" class="review-photo w-100" loading="lazy" decoding="async">
                  </div>
                  {% endfor %}
                </div>
              {% else %}
                <div class="text-muted">Customer photos will appear here after verified purchases share them.</div>
              {% endif %}
            </div>
          </div>
        </section>


              </div>
     </div>
{% endblock %}
