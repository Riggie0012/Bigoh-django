{% extends 'base.html' %}
{% block title %}{{ product[1] }} | {{ business_name }}{% endblock %}
{% block extra_head %}
<style>
  .single-page {
    background: #f8fafc;
    min-height: 100vh;
  }
  .single-hero {
    border-radius: 20px;
    padding: 22px;
    background: #ffffff;
    color: #0f172a;
    box-shadow: 0 12px 30px rgba(15, 23, 42, 0.08);
    border: 1px solid #e2e8f0;
  }
  .single-hero::after { content: none; }
  .single-chip {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 6px 12px;
    border-radius: 999px;
    background: #eef2ff;
    color: #3730a3;
    font-size: 12px;
    letter-spacing: 0.06em;
    text-transform: uppercase;
  }
  .single-title {
    font-size: clamp(28px, 4vw, 40px);
    font-weight: 700;
    margin: 14px 0 10px;
  }
  .single-sub {
    color: #0f172a;
    max-width: 520px;
  }
  .single-card {
    background: #fff;
    border-radius: 18px;
    border: 1px solid #e2e8f0;
    box-shadow: 0 12px 24px rgba(15, 23, 42, 0.06);
  }
  .media-card {
    padding: 20px;
  }
  .media-card img {
    width: 100%;
    border-radius: 18px;
    object-fit: cover;
    aspect-ratio: 4 / 3;
    background: #f1f5f9;
    transition: transform 0.3s ease;
  }
  .media-card:hover img {
    transform: scale(1.06);
  }
  .meta-card {
    padding: 20px 22px;
  }
  .meta-row {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    margin-top: 14px;
  }
  .meta-pill {
    background: #eef2ff;
    color: #3730a3;
    padding: 6px 12px;
    border-radius: 999px;
    font-size: 12px;
    font-weight: 600;
  }
  .trust-strip {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 10px;
    margin-top: 14px;
  }
  .trust-strip span {
    display: flex;
    align-items: center;
    gap: 8px;
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    padding: 10px 12px;
    border-radius: 12px;
    font-size: 13px;
    color: #0f172a;
  }
  .buy-card {
    padding: 22px;
    position: sticky;
    top: 24px;
  }
  .price-tag {
    font-size: 28px;
    font-weight: 700;
    color: #dc2626;
  }
  .rating-line {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 14px;
  }
  .rating-stars {
    color: #f59e0b;
  }
  .section-title {
    font-size: 22px;
    font-weight: 700;
    margin: 0 0 10px;
  }
  .review-card {
    border: 1px solid #e2e8f0;
    border-radius: 16px;
    padding: 16px;
    background: #fff;
  }
  .review-photo {
    width: 100%;
    max-width: 240px;
    border-radius: 14px;
    border: 1px solid rgba(148, 163, 184, 0.3);
  }
  .info-panel {
    background: #ffffff;
    color: #0f172a;
    border-radius: 18px;
    padding: 16px;
    border: 1px solid #e2e8f0;
  }
  .info-panel .small {
    color: #64748b;
  }
  .form-card {
    border-radius: 18px;
    background: #f8fafc;
    border: 1px solid rgba(148, 163, 184, 0.2);
  }
  .feedback-card {
    background: #ffffff;
    border-radius: 22px;
    border: 1px solid rgba(148, 163, 184, 0.2);
    box-shadow: 0 18px 36px rgba(15, 23, 42, 0.08);
    overflow: hidden;
  }
  .feedback-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 18px 22px;
    border-bottom: 1px solid rgba(148, 163, 184, 0.2);
  }
  .feedback-link {
    color: #f97316;
    font-weight: 600;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }
  .feedback-body {
    display: grid;
    grid-template-columns: minmax(240px, 320px) 1fr;
    gap: 22px;
    padding: 22px;
  }
  .feedback-subtitle {
    font-size: 13px;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: #64748b;
    margin-bottom: 12px;
    font-weight: 600;
  }
  .ratings-box {
    background: #f5f5f5;
    border-radius: 14px;
    padding: 18px;
    text-align: center;
    margin-bottom: 16px;
  }
  .ratings-score {
    font-size: 36px;
    font-weight: 700;
    color: #f59e0b;
  }
  .ratings-stars {
    color: #f59e0b;
    font-size: 16px;
    margin: 8px 0 6px;
  }
  .ratings-count {
    color: #334155;
    font-size: 14px;
  }
  .ratings-bars .bar-row {
    display: grid;
    grid-template-columns: 18px 1fr 36px;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
    font-size: 14px;
  }
  .ratings-bars .bar-track {
    height: 8px;
    background: #e5e7eb;
    border-radius: 999px;
    overflow: hidden;
  }
  .ratings-bars .bar-fill {
    height: 100%;
    background: #f59e0b;
  }
  .review-item {
    padding: 14px 0;
    border-bottom: 1px solid rgba(148, 163, 184, 0.2);
  }
  .review-item:last-child {
    border-bottom: none;
  }
  .review-title {
    font-weight: 700;
    margin-bottom: 4px;
  }
  .review-meta {
    color: #94a3b8;
    font-size: 13px;
  }
  .verified-pill {
    color: #16a34a;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }
  @media (max-width: 991px) {
    .feedback-body {
      grid-template-columns: 1fr;
    }
  }
  @media (max-width: 991px) {
    .buy-card {
      position: static;
    }
  }
</style>
{% endblock %}
{% block content %}
<div class="single-page">
  <div class="container py-4">
    <section class="row g-4 align-items-start">
      <div class="col-lg-7">
        <div class="single-card media-card mb-3">
          <img src="{{ image_url(product[7]) }}" alt="{{ product[1] }}" loading="lazy" decoding="async">
        </div>
        <div class="single-card meta-card mb-3">
          <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
            <div>
              <div class="text-muted">Category</div>
              <div class="fw-semibold">{{ product[2] }}</div>
            </div>
            {% if review_count and review_count > 0 %}
            <div class="rating-line">
              <span class="rating-stars">
                {% for i in range(1, 6) %}
                  {% if i <= avg_rating_int %}&#9733;{% else %}&#9734;{% endif %}
                {% endfor %}
              </span>
              <span class="text-muted">{{ avg_rating }}/5 · {{ review_count }} reviews</span>
            </div>
            {% else %}
            <div class="text-muted small">No reviews yet.</div>
            {% endif %}
          </div>
          <div class="trust-strip">
            <span><i class="fa-solid fa-lock"></i> Secure checkout (SSL)</span>
            <span><i class="fa-solid fa-circle-check"></i> Quality checked</span>
            <span><i class="fa-solid fa-shield-halved"></i> Dispute support</span>
          </div>
          {% if product[5] is not none and product[5]|int <= 5 %}
          <div class="text-danger small mt-3">Low stock: {{ product[5] }} left</div>
          {% endif %}
        </div>
        <div class="info-panel">
          <div class="fw-semibold mb-1">Why customers love it</div>
          <div class="small">Consistent quality, verified seller support, and smooth delivery updates via WhatsApp.</div>
        </div>
      </div>

      <div class="col-lg-5">
        <div class="single-card buy-card">
          <div class="mb-3">
          <div class="single-title">{{ product[1] }}</div>
          <div class="text-muted small mb-2">Category: {{ product[2] }}</div>
          {% if seller %}
          <div class="text-muted small mb-2">Seller: {{ seller }}</div>
          {% endif %}
          <div class="single-sub">{{ product[6] }}</div>
          </div>
          <div class="price-tag">KES {{ product[4] }}</div>
          <div class="text-muted small mb-3">Pay on delivery or add to cart for checkout.</div>

          <form method="POST" action="/add_to_cart/{{ product[0] }}" class="d-flex align-items-center gap-2 mb-3">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="number" name="qty" value="1" min="1" class="form-control" style="width:120px;">
            <button class="btn btn-success flex-grow-1">Add to Cart</button>
          </form>
          {% if product[5] is not none and product[5]|int <= 0 %}
          <form method="POST" action="/product/{{ product[0] }}/stock-alert" class="d-flex flex-wrap align-items-center gap-2 mb-3">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="email" name="email" class="form-control" placeholder="Your email for restock alerts" required style="width:220px;">
            <button class="btn btn-outline-dark">Notify me</button>
          </form>
          {% endif %}

          {% if request.args.get('err') == 'location' %}
          <div class="alert alert-danger py-2">Please enter delivery location.</div>
          {% endif %}

          <form method="POST" action="{{ url_for('pay_on_delivery') }}" class="form-card p-3">
            <input type="hidden" name="product_id" value="{{ product[0] }}">
            <label class="form-label">Quantity</label>
            <input type="number" name="quantity" value="1" min="1" class="form-control" required>
            <label class="form-label mt-2">Delivery Location</label>
            <input type="text" name="location" class="form-control" placeholder="e.g., Nairobi CBD, OTC stage..." required>
            <button type="submit" class="btn btn-dark w-100 mt-3">Pay on Delivery (WhatsApp)</button>
          </form>
        </div>
      </div>
    </section>

    <section class="row mt-5">
      <div class="col-12">
        <div class="feedback-card">
          <div class="feedback-header">
            <h4 class="section-title mb-0">Customer Feedback</h4>
            <a class="feedback-link" href="#reviews">See All <i class="fa-solid fa-chevron-right"></i></a>
          </div>
          <div class="feedback-body">
            <div>
              <div class="feedback-subtitle">Verified Ratings ({{ review_count }})</div>
              <div class="ratings-box">
                <div class="ratings-score">{{ avg_rating }}/5</div>
                <div class="ratings-stars">
                  {% for i in range(1, 6) %}
                    {% if i <= avg_rating_int %}&#9733;{% else %}&#9734;{% endif %}
                  {% endfor %}
                </div>
                <div class="ratings-count">{{ review_count }} verified ratings</div>
              </div>
              <div class="ratings-bars">
                {% for star in range(5, 0, -1) %}
                {% set count = rating_breakdown.get(star, 0) %}
                {% set pct = (count / review_count * 100) if review_count else 0 %}
                <div class="bar-row">
                  <span>{{ star }}</span>
                  <div class="bar-track"><div class="bar-fill" style="width: {{ pct }}%"></div></div>
                  <span>({{ count }})</span>
                </div>
                {% endfor %}
              </div>
            </div>
            <div id="reviews">
              <div class="feedback-subtitle">Product Reviews ({{ review_count }})</div>
              {% if reviews and reviews|length > 0 %}
                {% for r in reviews %}
                <div class="review-item">
                  <div class="text-warning small mb-1">
                    {% for i in range(1, 6) %}
                      {% if i <= (r.rating or 0) %}&#9733;{% else %}&#9734;{% endif %}
                    {% endfor %}
                  </div>
                  <div class="review-title">{{ r.comment }}</div>
                  <div class="review-meta">{{ r.created_at }} · {{ r.user_name }}</div>
                  {% if r.verified %}
                    <div class="verified-pill mt-2"><i class="fa-regular fa-circle-check"></i> Verified Purchase</div>
                  {% endif %}
                  {% if r.photo %}
                    <img src="{{ url_for('static', filename=r.photo) }}" alt="Customer photo" class="review-photo mt-2" loading="lazy" decoding="async">
                  {% elif r.photo_pending %}
                    <div class="mt-2">
                      <span class="badge bg-warning text-dark">Pending approval</span>
                    </div>
                    <img src="{{ url_for('static', filename=r.photo_pending_path) }}" alt="Your photo pending approval" class="review-photo mt-2" loading="lazy" decoding="async">
                  {% endif %}
                </div>
                {% endfor %}
              {% else %}
                <div class="text-muted">No reviews yet. Be the first to review this product.</div>
              {% endif %}
            </div>
          </div>
        </div>

        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mt-4 mb-2">
          <div class="text-muted small">Only verified purchasers can submit reviews.</div>
        </div>

        {% if request.args.get('review') == 'ok' %}
          <div class="alert alert-success py-2">Thanks! Your review has been submitted.</div>
        {% elif request.args.get('review') == 'error' %}
          <div class="alert alert-danger py-2">Please provide a rating and comment.</div>
        {% elif request.args.get('review') == 'verified-only' %}
          <div class="alert alert-warning py-2">Only verified purchasers can submit reviews.</div>
        {% elif request.args.get('review') == 'photo-type' %}
          <div class="alert alert-danger py-2">Photo must be JPG, PNG, or WEBP.</div>
        {% elif request.args.get('review') == 'photo-size' %}
          <div class="alert alert-danger py-2">Photo is too large. Please upload a smaller image.</div>
        {% endif %}

        {% if session.get('key') and can_review %}
        <form method="POST" action="/product/{{ product[0] }}/review" class="single-card p-3 mb-3" enctype="multipart/form-data">
          <div class="row g-2 align-items-end">
            <div class="col-md-3">
              <label class="form-label">Rating</label>
              <select name="rating" class="form-select" required>
                <option value="">Select</option>
                <option value="5">5 - Excellent</option>
                <option value="4">4 - Great</option>
                <option value="3">3 - Good</option>
                <option value="2">2 - Fair</option>
                <option value="1">1 - Poor</option>
              </select>
            </div>
            <div class="col-md-7">
              <label class="form-label">Comment</label>
              <input type="text" name="comment" class="form-control" maxlength="500" required>
            </div>
            <div class="col-md-2">
              <button class="btn btn-primary w-100" type="submit">Submit</button>
            </div>
            <div class="col-md-12">
              <label class="form-label">Photo (verified purchases only)</label>
              <input type="file" name="photo" accept="image/png,image/jpeg,image/webp" class="form-control">
              <div class="form-text">Upload a real photo from your purchase to help others trust the product.</div>
            </div>
          </div>
        </form>
        {% elif session.get('key') %}
        <div class="alert alert-warning py-2">You can review this product after a completed purchase.</div>
        {% else %}
        <div class="alert alert-info py-2">Please sign in to leave a review.</div>
        <a class="btn btn-outline-primary" href="/signin">Sign In</a>
        {% endif %}
      </div>
    </section>

  </div>
</div>
{% endblock %}
